generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model clientes {
  id           String         @id @db.Uuid
  razonSocial  String         @db.VarChar(255)
  cuit         String         @unique @db.VarChar(11)
  r2Prefix     String         @db.VarChar(50)
  activo       Boolean        @default(true)
  createdAt    DateTime       @default(now()) @db.Timestamptz(3)
  updatedAt    DateTime       @db.Timestamptz(3)
  documentos   documentos[]
  ingest_queue ingest_queue[]
  pagos        pagos[]
  proveedores  proveedores[]
  usuarios     usuarios[]
}

model documento_items {
  id             String     @id @db.Uuid
  documentoId    String     @db.Uuid
  linea          Int
  descripcion    String @db.Uuid
  codigo         String?    @db.VarChar(100)
  cantidad       Decimal?   @db.Decimal(14, 3)
  unidad         String?    @db.VarChar(20)
  precioUnitario Decimal?   @db.Decimal(14, 2)
  subtotal       Decimal?   @db.Decimal(14, 2)
  documentos     documentos @relation(fields: [documentoId], references: [id], onDelete: Cascade)

  @@index([documentoId])
}

model documento_revisiones {
  id          String         @id @db.Uuid
  documentoId String         @db.Uuid
  usuarioId   String         @db.Uuid
  accion      AccionRevision
  path        String         @db.VarChar(255)
  before      Json?
  after       Json?
  createdAt   DateTime       @default(now()) @db.Timestamptz(3)
  documentos  documentos     @relation(fields: [documentoId], references: [id], onDelete: Cascade)
  usuarios    usuarios       @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([documentoId, createdAt(sort: Desc)])
}

model documentos {
  id                   String                 @id @db.Uuid
  clienteId            String                 @db.Uuid
  proveedorId          String?                @db.Uuid
  tipo                 TipoDocumento
  letra                LetraFactura?
  puntoVenta           String?                @db.VarChar(10)
  numero               String?                @db.VarChar(20)
  numeroCompleto       String?                @db.VarChar(50)
  fechaEmision         DateTime?              @db.Date
  fechaVencimiento     DateTime?              @db.Date
  moneda               String                 @default("ARS") @db.VarChar(3)
  subtotal             Decimal?               @db.Decimal(14, 2)
  iva                  Decimal?               @db.Decimal(14, 2)
  total                Decimal?               @db.Decimal(14, 2)
  confidenceScore      Int?
  estadoRevision       EstadoRevision         @default(PENDIENTE)
  missingFields        Json                   @default("[]")
  jsonNormalizado      Json                   @default("{}")
  source               SourceDocumento
  hashSha256           String                 @db.VarChar(64)
  pdfRawKey            String                 @db.VarChar(500)
  pdfFinalKey          String?                @db.VarChar(500)
  textractRawKey       String?                @db.VarChar(500)
  createdAt            DateTime               @default(now()) @db.Timestamptz(3)
  updatedAt            DateTime               @db.Timestamptz(3)
  documento_items      documento_items[]
  documento_revisiones documento_revisiones[]
  clientes             clientes               @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  proveedores          proveedores?           @relation(fields: [proveedorId], references: [id])
  pago_documentos      pago_documentos[]

  @@unique([clienteId, hashSha256])
  @@index([clienteId, estadoRevision])
  @@index([clienteId, fechaEmision])
  @@index([clienteId, numeroCompleto])
  @@index([clienteId, proveedorId])
  @@index([hashSha256])
}

model ingest_queue {
  id          String            @id @db.Uuid
  clienteId   String            @db.Uuid
  source      SourceIngestQueue
  sourceRef   String            @db.VarChar(500)
  sha256      String?           @db.VarChar(64)
  status      StatusIngestQueue @default(PENDING)
  attempts    Int               @default(0)
  nextRetryAt DateTime?         @db.Timestamptz(3)
  lastError   String?
  createdAt   DateTime          @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime          @db.Timestamptz(3)
  clientes    clientes          @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@unique([clienteId, source, sourceRef])
  @@index([clienteId, status])
  @@index([status, nextRetryAt])
}

model pago_documentos {
  pagoId        String     @db.Uuid
  documentoId   String     @db.Uuid
  montoAplicado Decimal    @db.Decimal(14, 2)
  createdAt     DateTime   @default(now()) @db.Timestamptz(3)
  documentos    documentos @relation(fields: [documentoId], references: [id], onDelete: Cascade)
  pagos         pagos      @relation(fields: [pagoId], references: [id], onDelete: Cascade)

  @@id([pagoId, documentoId])
}

model pago_metodos {
  id     String         @id @db.Uuid
  pagoId String         @db.Uuid
  tipo   TipoPagoMetodo
  monto  Decimal        @db.Decimal(14, 2)
  meta   Json           @default("{}")
  pagos  pagos          @relation(fields: [pagoId], references: [id], onDelete: Cascade)

  @@index([pagoId])
}

model pagos {
  id              String            @id @db.Uuid
  clienteId       String            @db.Uuid
  proveedorId     String            @db.Uuid
  fecha           DateTime          @db.Date
  estado          EstadoPago        @default(BORRADOR)
  moneda          String            @default("ARS") @db.VarChar(3)
  montoTotal      Decimal           @db.Decimal(14, 2)
  nota            String?
  comprobanteKey  String?           @db.VarChar(500)
  createdAt       DateTime          @default(now()) @db.Timestamptz(3)
  updatedAt       DateTime          @db.Timestamptz(3)
  pago_documentos pago_documentos[]
  pago_metodos    pago_metodos[]
  clientes        clientes          @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  proveedores     proveedores       @relation(fields: [proveedorId], references: [id], onDelete: Cascade)

  @@index([clienteId, fecha])
  @@index([clienteId, proveedorId])
}

model proveedores {
  id          String        @id @db.Uuid
  clienteId   String        @db.Uuid
  razonSocial String        @db.VarChar(255)
  cuit        String?       @db.VarChar(11)
  alias       Json          @default("[]")
  letra       String?       @db.VarChar(1)
  activo      Boolean       @default(true)
  createdAt   DateTime      @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime      @db.Timestamptz(3)
  documentos  documentos[]
  pagos       pagos[]
  clientes    clientes      @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@unique([clienteId, cuit])
  @@index([clienteId])
  @@index([clienteId, razonSocial])
}

model usuarios {
  id                   String                 @id @db.Uuid
  email                String                 @unique @db.VarChar(255)
  nombre               String                 @db.VarChar(255)
  rol                  RolUsuario
  clienteId            String?                @db.Uuid
  activo               Boolean                @default(true)
  createdAt            DateTime               @default(now()) @db.Timestamptz(3)
  updatedAt            DateTime               @db.Timestamptz(3)
  documento_revisiones documento_revisiones[]
  clientes             clientes?              @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@index([clienteId])
  @@index([rol])
}

enum AccionRevision {
  SET_FIELD
  SET_PROVIDER
  EDIT_ITEM
  CONFIRM
}

enum EstadoPago {
  BORRADOR
  PAGADO
  ANULADO
}

enum EstadoRevision {
  PENDIENTE
  CONFIRMADO
  ERROR
  DUPLICADO
}

enum LetraFactura {
  A
  B
  C
}

enum RolUsuario {
  SUPERADMIN
  ADMIN
  USER
}

enum SourceDocumento {
  SFTP
  EMAIL
  WHATSAPP
  MANUAL
}

enum SourceIngestQueue {
  SFTP
  DRIVE
}

enum StatusIngestQueue {
  PENDING
  PROCESSING
  DONE
  ERROR
}

enum TipoDocumento {
  FACTURA
  REMITO
  NOTA_CREDITO
}

enum TipoPagoMetodo {
  EFECTIVO
  TRANSFERENCIA
  CHEQUE
}
