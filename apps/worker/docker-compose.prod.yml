version: '3.8'

services:
  watcher:
    build:
      context: ../../
      dockerfile: apps/worker/Dockerfile
    container_name: axp-watcher
    working_dir: /app/apps/worker
    volumes:
      # Directorios compartidos con webdav
      - /srv/webdav/data:/data:rw
      - /srv/webdav/processed:/processed:rw
      - /srv/webdav/failed:/failed:rw
    environment:
      - NODE_ENV=production
      - WORKER_MODE=watcher
      - WEBDAV_DIR=/data
      - PROCESSED_DIR=/processed
      - FAILED_DIR=/failed
      - WATCHER_POLL_INTERVAL=2000
      - FILE_STABLE_CHECKS=3
      - PREFIX_MAP_PATH=./prefix-map.json
      - DATABASE_URL=${DATABASE_URL}
    restart: unless-stopped

  processor:
    build:
      context: ../../
      dockerfile: apps/worker/Dockerfile
    container_name: axp-processor
    working_dir: /app/apps/worker
    volumes:
      # Solo necesita acceso a processed
      - /srv/webdav/processed:/processed:rw
    environment:
      - NODE_ENV=production
      - WORKER_MODE=processor
      - PROCESSED_DIR=/processed
      - PROCESSOR_POLL_INTERVAL=5000
      - MAX_CONCURRENT_JOBS=3
      - MAX_RETRY_ATTEMPTS=5
      - PREFIX_MAP_PATH=./prefix-map.json
      - DATABASE_URL=${DATABASE_URL}
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
    restart: unless-stopped
